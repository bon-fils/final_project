<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple Fingerprint Integration Test</title>
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <style>
        .container { max-width: 800px; margin: 50px auto; }
        .fingerprint-section { 
            border: 2px solid #ddd; 
            border-radius: 10px; 
            padding: 20px; 
            margin: 20px 0; 
        }
        .status { 
            padding: 10px; 
            border-radius: 5px; 
            margin: 10px 0; 
            font-weight: bold; 
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        .warning { background: #fff3cd; color: #856404; }
        pre { 
            background: #f8f9fa; 
            padding: 10px; 
            border-radius: 3px; 
            max-height: 200px; 
            overflow-y: auto; 
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîê Simple Fingerprint Integration Test</h1>
        <p>This tests the exact same approach as the registration form</p>

        <!-- Student Info (Mock) -->
        <div class="fingerprint-section">
            <h3>üë§ Mock Student Info</h3>
            <div class="row">
                <div class="col-md-6">
                    <label>First Name:</label>
                    <input type="text" id="firstName" class="form-control" value="John" placeholder="First Name">
                </div>
                <div class="col-md-6">
                    <label>Last Name:</label>
                    <input type="text" id="lastName" class="form-control" value="Doe" placeholder="Last Name">
                </div>
            </div>
            <div class="mt-3">
                <label>Registration Number:</label>
                <input type="text" id="regNo" class="form-control" value="TEST2024001" placeholder="Registration Number">
            </div>
        </div>

        <!-- Fingerprint Capture -->
        <div class="fingerprint-section">
            <h3>üëÜ Fingerprint Capture</h3>
            <div class="row">
                <div class="col-md-6">
                    <div id="fingerprintCanvas" style="width: 200px; height: 200px; border: 2px dashed #ccc; display: flex; align-items: center; justify-content: center; margin: 10px 0;">
                        <span id="fingerprintPlaceholder">üëÜ Fingerprint will appear here</span>
                    </div>
                    <div id="fingerprintStatus" class="status info">Ready to capture</div>
                </div>
                <div class="col-md-6">
                    <button id="captureBtn" class="btn btn-primary btn-lg" onclick="startCapture()">
                        <i class="fas fa-fingerprint"></i> Capture Fingerprint
                    </button>
                    <button id="enrollBtn" class="btn btn-success btn-lg d-none" onclick="enrollFingerprint()">
                        <i class="fas fa-save"></i> Enroll Fingerprint
                    </button>
                    <button id="clearBtn" class="btn btn-secondary d-none" onclick="clearFingerprint()">
                        <i class="fas fa-times"></i> Clear
                    </button>
                </div>
            </div>
        </div>

        <!-- Results -->
        <div class="fingerprint-section">
            <h3>üìä Results</h3>
            <div id="results"></div>
        </div>

        <!-- Raw Responses -->
        <div class="fingerprint-section">
            <h3>üìÑ ESP32 Communication Log</h3>
            <pre id="communicationLog"></pre>
        </div>
    </div>

    <script>
        const ESP32_IP = '192.168.137.220';
        const ESP32_PORT = 80;
        let fingerprintCaptured = false;
        let fingerprintData = null;
        let isCapturing = false;

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const results = document.getElementById('results');
            const className = type === 'success' ? 'success' : type === 'error' ? 'error' : type === 'warning' ? 'warning' : 'info';
            results.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            results.scrollTop = results.scrollHeight;
            
            // Also log to communication log
            const commLog = document.getElementById('communicationLog');
            commLog.textContent += `[${timestamp}] ${message}\n`;
            commLog.scrollTop = commLog.scrollHeight;
        }

        async function makeESP32Request(endpoint, method = 'GET', data = null) {
            const url = `http://${ESP32_IP}:${ESP32_PORT}${endpoint}`;
            log(`üîÑ ${method} ${url}`, 'info');

            try {
                const options = {
                    method: method,
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    mode: 'cors'
                };

                if (data && method === 'POST') {
                    options.body = new URLSearchParams(data).toString();
                } else if (data && method === 'GET') {
                    const params = new URLSearchParams(data).toString();
                    const separator = url.includes('?') ? '&' : '?';
                    return makeESP32Request(`${endpoint}${separator}${params}`, 'GET');
                }

                const response = await fetch(url, options);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const responseText = await response.text();
                let responseData;
                
                try {
                    responseData = JSON.parse(responseText);
                } catch (e) {
                    responseData = responseText;
                }

                log(`‚úÖ Response: ${JSON.stringify(responseData)}`, 'success');
                return { success: true, data: responseData };

            } catch (error) {
                log(`‚ùå Error: ${error.message}`, 'error');
                return { success: false, error: error.message };
            }
        }

        function updateStatus(message, type = 'info') {
            const statusEl = document.getElementById('fingerprintStatus');
            statusEl.className = `status ${type}`;
            statusEl.textContent = message;
        }

        function updateUI(state) {
            const captureBtn = document.getElementById('captureBtn');
            const enrollBtn = document.getElementById('enrollBtn');
            const clearBtn = document.getElementById('clearBtn');

            switch (state) {
                case 'capturing':
                    captureBtn.disabled = true;
                    captureBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Capturing...';
                    enrollBtn.classList.add('d-none');
                    clearBtn.classList.add('d-none');
                    break;

                case 'captured':
                    captureBtn.classList.add('d-none');
                    enrollBtn.classList.remove('d-none');
                    clearBtn.classList.remove('d-none');
                    break;

                case 'enrolled':
                    captureBtn.classList.add('d-none');
                    enrollBtn.classList.add('d-none');
                    clearBtn.classList.remove('d-none');
                    break;

                default: // ready
                    captureBtn.disabled = false;
                    captureBtn.innerHTML = '<i class="fas fa-fingerprint"></i> Capture Fingerprint';
                    captureBtn.classList.remove('d-none');
                    enrollBtn.classList.add('d-none');
                    clearBtn.classList.add('d-none');
            }
        }

        async function startCapture() {
            if (isCapturing) return;

            isCapturing = true;
            fingerprintCaptured = false;
            updateUI('capturing');
            updateStatus('Checking ESP32 connection...', 'info');

            try {
                // Step 1: Check ESP32 status
                const statusResult = await makeESP32Request('/status');
                if (!statusResult.success) {
                    throw new Error('ESP32 not responding');
                }

                if (!statusResult.data.fingerprint_sensor || statusResult.data.fingerprint_sensor !== 'connected') {
                    throw new Error('Fingerprint sensor not connected');
                }

                updateStatus('ESP32 connected. Place finger on sensor...', 'info');

                // Step 2: Send display message
                await makeESP32Request('/display', 'GET', { message: 'Place finger on sensor...' });

                // Step 3: Start polling for fingerprint
                const maxAttempts = 50; // 10 seconds at 200ms intervals
                let attempts = 0;

                const pollInterval = setInterval(async () => {
                    attempts++;
                    updateStatus(`Scanning... (${attempts}/${maxAttempts})`, 'info');

                    try {
                        const identifyResult = await makeESP32Request('/identify');
                        
                        if (identifyResult.success && identifyResult.data.success) {
                            // Fingerprint detected!
                            clearInterval(pollInterval);
                            fingerprintCaptured = true;
                            fingerprintData = identifyResult.data;
                            
                            updateStatus(`‚úÖ Fingerprint captured! ID: ${identifyResult.data.fingerprint_id}, Confidence: ${identifyResult.data.confidence}%`, 'success');
                            updateUI('captured');
                            isCapturing = false;

                            // Update display
                            await makeESP32Request('/display', 'GET', { message: 'Fingerprint captured!' });
                            
                            // Visual feedback
                            document.getElementById('fingerprintPlaceholder').innerHTML = `
                                <div style="text-align: center;">
                                    <i class="fas fa-fingerprint fa-3x text-success"></i><br>
                                    <small>ID: ${identifyResult.data.fingerprint_id}<br>
                                    Confidence: ${identifyResult.data.confidence}%</small>
                                </div>
                            `;

                        } else if (attempts >= maxAttempts) {
                            // Timeout
                            clearInterval(pollInterval);
                            throw new Error('Timeout: No fingerprint detected');
                        }

                    } catch (pollError) {
                        log(`Poll attempt ${attempts} failed: ${pollError.message}`, 'warning');
                    }

                }, 200);

            } catch (error) {
                log(`Capture failed: ${error.message}`, 'error');
                updateStatus(`‚ùå Capture failed: ${error.message}`, 'error');
                updateUI('ready');
                isCapturing = false;
            }
        }

        async function enrollFingerprint() {
            if (!fingerprintCaptured) {
                log('No fingerprint captured to enroll', 'error');
                return;
            }

            const studentName = document.getElementById('firstName').value + ' ' + document.getElementById('lastName').value;
            const regNo = document.getElementById('regNo').value;

            if (!studentName.trim() || !regNo.trim()) {
                log('Student name and registration number required', 'error');
                return;
            }

            try {
                updateStatus('Enrolling fingerprint...', 'info');

                const fingerprintId = Date.now() % 1000;
                const enrollResult = await makeESP32Request('/enroll', 'POST', {
                    id: fingerprintId,
                    student_name: studentName,
                    reg_no: regNo
                });

                if (enrollResult.success && enrollResult.data.success) {
                    updateStatus('‚úÖ Fingerprint enrolled successfully!', 'success');
                    updateUI('enrolled');
                    await makeESP32Request('/display', 'GET', { message: 'Enrollment complete!' });
                    log(`Fingerprint enrolled for ${studentName} (${regNo})`, 'success');
                } else {
                    throw new Error(enrollResult.data.error || 'Enrollment failed');
                }

            } catch (error) {
                log(`Enrollment failed: ${error.message}`, 'error');
                updateStatus(`‚ùå Enrollment failed: ${error.message}`, 'error');
            }
        }

        function clearFingerprint() {
            fingerprintCaptured = false;
            fingerprintData = null;
            isCapturing = false;
            
            document.getElementById('fingerprintPlaceholder').innerHTML = 'üëÜ Fingerprint will appear here';
            updateStatus('Ready to capture', 'info');
            updateUI('ready');
            log('Fingerprint cleared', 'info');
        }

        // Initialize
        window.addEventListener('load', () => {
            log('üöÄ Simple Fingerprint Test initialized', 'info');
            log(`üì° ESP32 Target: http://${ESP32_IP}:${ESP32_PORT}`, 'info');
            updateUI('ready');
        });
    </script>
</body>
</html>
